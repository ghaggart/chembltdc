# An integrated ChEMBL/TDC database, plus a REST API for accessing.

Copyright 2022 Gordon Andrew Haggart - All rights reserved

This is an incomplete approach to integrating ChEMBL and the Therapeutic Data Commons database. Licence is under the GNU/GPLv3 licence, meaning it cannot be distributed in closed-source applications. 

The importer (lib/tdc_import.py) uses SQLAlchemy to add the TDC data to the relevant database models. It is currently incomplete, with further TODOs marked for adding publications (docs), sources, and logging. These will be parsed from a JSON object.

Please see the TODO: comments in the tdc_import.py file for more information as to what is currently incomplete.

There is a Flask-Appbuilder Model REST API that enables REST requests querying specific models, with documentation automatically generated by Swagger. This is easily generated using the SQLAlchemy models used for DAO.

FAB documention: https://flask-appbuilder.readthedocs.io/en/latest/**

The SQLAlchemy model definitions were taken from https://github.com/kzfm/pychembldb/blob/master/pychembldb/__init__.py

This is slightly out of date for the most recent version of ChEMBL, but provides enough table/feature coverage to get started.

### Local setup
To get started with local development, install docker, clone this repo, cd to the directory, and run ```docker compose up postgres```. 

You will need to shell inside the repo and install the ChEMBL database from source following their instructions.

Once that is setup, you can then bring up the API and nginx containers using ```docker compose up``` 

To import the TDC data into a fresh ChEMBL instance, get a shell inside the api container and run ```python /opt/lib/tdc_import.py```

To view the API documentation go to http://localhost/swagger/v1

Its recommended you change the passwords in the .env file to something more secure.

### Using the API
The API uses the Flask-AppBuilder SQLAlchemy model API. Connection is a 2 stage process, firstly you must generate a token using a registered username and password. For local deployments you can use the values specified in API_ADMIN_USER and API_ADMIN_PASSWORD.

For cloud-hosted deployments change 'localhost' to the hostname/IP address of the server

1. Generating a token

```python
import os
import requests
import json
import prison
        
session = requests.session()
response = session.post('http://localhost/api/v1/security/login',json={"username": os.environ['API_ADMIN_USER'],"password": os.environ['API_ADMIN_PASSWORD'],"provider": "db"})
if response.status_code == 200:
    content = json.loads(response.content.decode('utf-8'))
    token = content['access_token']
```    

2. Making a request
```python
filters = [{"col": "canonical_smiles", "opr": "eq", "value":"Cc1cc(-n2ncc(=O)[nH]c2=O)ccc1C(=O)c1ccc(C#N)cc1"}]
response = session.get(f"http://localhost/api/v1/compound_structure",
                        params={"q":prison.dumps({"filters": filters})},
                        headers={'Authorization': 'Bearer '+ token})
if response.status_code == 200:
    content = json.loads(response.content.decode('utf-8'))
    print(content)

""{'count': 1,
 'description_columns': {},
 'ids': [2],
 'label_columns': {'canonical_smiles': 'Canonical Smiles',
                   'molecule': 'Molecule',
                   'molfile': 'Molfile',
                   'standard_inchi': 'Standard Inchi',
                   'standard_inchi_key': 'Standard Inchi Key'},
 'list_columns': ['molfile',
                  'standard_inchi',
                  'standard_inchi_key',
                  'canonical_smiles',
                  'molecule'],
 'list_title': 'List Compound Structure',
 'order_columns': ['molfile',
                   'standard_inchi',
                   'standard_inchi_key',
                   'canonical_smiles'],
 'result': [{'canonical_smiles': 'Cc1cc(-n2ncc(=O)[nH]c2=O)ccc1C(=O)c1ccc(C#N)cc1',
             'molecule': {'availability_type': -1,
                          'black_box_warning': 0,
                          'chebi_par_id': None,
                          'chirality': -1,
                          'dosed_ingredient': 0,
                          'first_approval': None,
                          'first_in_class': -1,
                          'indication_class': None,
                          'inorganic_flag': -1,
                          'max_phase': 0,
                          'molecule_type': 'Small molecule',
                          'molregno': 2,
                          'natural_product': -1,
                          'oral': 0,
                          'parenteral': 0,
                          'polymer_flag': 0,
                          'pref_name': None,
                          'prodrug': -1,
                          'structure_type': 'MOL',
                          'therapeutic_flag': 0,
                          'topical': 0,
                          'usan_stem': None,
                          'usan_stem_definition': None,
                          'usan_substem': None,
                          'usan_year': None,
                          'withdrawn_class': None,
                          'withdrawn_country': None,
                          'withdrawn_flag': 0,
                          'withdrawn_reason': None,
                          'withdrawn_year': None},
             'molfile': '\n'
                        '     RDKit          2D\n'
                        '\n'
                        ' 25 27  0  0  0  0  0  0  0  0999 V2000\n'
                        '    5.2792   -2.0500    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7917   -2.3500    0.0000 N   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.2792   -1.4500    0.0000 N   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3125   -2.0500    0.0000 N   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3125   -1.4500    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7875   -4.1417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7917   -1.1500    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7917   -2.9500    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7875   -4.7417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.2667   -3.8417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    8.3792   -6.2417    0.0000 N   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.2667   -3.2417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3042   -3.8417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    7.8625   -5.9417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    4.7542   -2.3417    0.0000 O   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3042   -5.0417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3042   -3.2417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.2667   -5.0417    0.0000 O   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    5.7917   -0.5500    0.0000 O   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.3042   -5.6417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.8167   -4.7417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    7.3417   -5.6417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    7.3417   -5.0417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    6.8250   -5.9417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '    4.7417   -4.1417    0.0000 C   0  0  0  0  0  0  '
                        '0  0  0  0  0  0\n'
                        '  2  1  1  0\n'
                        '  3  1  1  0\n'
                        '  4  2  1  0\n'
                        '  5  7  1  0\n'
                        '  6 13  1  0\n'
                        '  7  3  1  0\n'
                        '  8  2  1  0\n'
                        '  9  6  1  0\n'
                        ' 10 12  1  0\n'
                        ' 11 14  3  0\n'
                        ' 12  8  2  0\n'
                        ' 13 17  2  0\n'
                        ' 14 22  1  0\n'
                        ' 15  1  2  0\n'
                        ' 16  9  1  0\n'
                        ' 17  8  1  0\n'
                        ' 18  9  2  0\n'
                        ' 19  7  2  0\n'
                        ' 20 16  2  0\n'
                        ' 21 16  1  0\n'
                        ' 22 23  1  0\n'
                        ' 23 21  2  0\n'
                        ' 24 20  1  0\n'
                        ' 25 10  1  0\n'
                        '  4  5  2  0\n'
                        ' 10  6  2  0\n'
                        ' 24 22  2  0\n'
                        'M  END',
             'standard_inchi': 'InChI=1S/C18H12N4O3/c1-11-8-14(22-18(25)21-16(23)10-20-22)6-7-15(11)17(24)13-4-2-12(9-19)3-5-13/h2-8,10H,1H3,(H,21,23,25)',
             'standard_inchi_key': 'ZJYUMURGSZQFMH-UHFFFAOYSA-N'}]}"
```
